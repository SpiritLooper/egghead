apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-openwrt-to-ohara
spec:
  schedule: "0 5 * * *" # Every day at 05:00 AM
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: restic-backup
            image: alpine:latest
            imagePullPolicy: IfNotPresent
            env:
              # --- Restic / MinIO Configuration ---
              - name: RESTIC_REPOSITORY
                value: "s3:https://ohara.infrao.top:9004/openwrt-backup"
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: openwrt-creds
                    key: ACCESS_KEY_ID
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: openwrt-creds
                    key: ACCESS_SECRET_KEY
              - name: RESTIC_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: openwrt-creds
                    key: restic-password
              # --- SSH / VPS Configuration ---
              - name: SSH_USER
                valueFrom:
                  secretKeyRef:
                    name: openwrt-creds
                    key: SSH_USER
              - name: OPENWRT_HOST
                value: "knock-up-stream.infrao.top"
            
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e # Stop script on error
                
                echo "--- 1. Installing dependencies ---"
                apk add --no-cache openssh-client restic bind-tools

                echo "--- 2. SSH Configuration ---"
                mkdir -p ~/.ssh
                # Copy key from Secret mount to .ssh directory
                cp /etc/secret/SSH_KEY ~/.ssh/id_ed25519
                chmod 600 ~/.ssh/id_ed25519
                # Avoid "Are you sure..." prompt for automation
                echo "StrictHostKeyChecking no" >> ~/.ssh/config

                echo "--- 2b. Waiting for DNS resolution (DIG) ---"              
                until [ -n "$(dig +short $OPENWRT_HOST)" ]; do
                    echo "Waiting for DNS resolution of $OPENWRT_HOST..."
                    sleep 5
                done
                
                RESOLVED_IP=$(dig +short $OPENWRT_HOST | tail -n1)
                echo "DNS resolved successfully: $OPENWRT_HOST -> $RESOLVED_IP"

                echo "--- 3. Repo Initialization (if necessary) ---"
                restic init || echo "Repository already exists, continuing."

                # ======================================================
                # PART A: OPENWRT BACKUP
                # ======================================================
                BACKUP_DEST=sysupgrade -b /tmp/backup.tar.gz
                echo "--- 4. Backing up OpenWRT configuration ---"

                ssh -i ~/.ssh/id_ed25519 $SSH_USER@$RESOLVED_IP "sysupgrade -b ${BACKUP_DEST}"
                scp -i ~/.ssh/id_ed25519 $SSH_USER@$RESOLVED_IP:${BACKUP_DEST} ${BACKUP_DEST}
                restic backup -v ${BACKUP_DEST} --tag openwrt --tag config --host $OPENWRT_HOST

                # ======================================================
                # PART B: CLEANUP (PRUNE)
                # ======================================================
                echo "--- 6. Pruning old snapshots ---"
                # Keep the last 7 snapshots (global policy)
                restic forget --keep-last 7 --prune

                echo "--- Backup completed successfully ---"

            volumeMounts:
            - name: ssh-key-vol
              mountPath: "/etc/secret"
              readOnly: true

          restartPolicy: OnFailure
          volumes:
          - name: ssh-key-vol
            secret:
              secretName: openwrt-creds
              items:
                - key: SSH_KEY
                  path: SSH_KEY